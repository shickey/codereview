"use strict";function on_gapi_loaded(){window.init_gapi?window.init_gapi():setTimeout(on_gapi_loaded,10)}var module=angular.module("gapi",[]);module.factory("googleApi",["$rootScope","$window","$q","apiKey","loadApis",function(a,b,c,d,e){var f=c.defer();return b.init_gapi=function(){a.$apply(function(){var a=[];d&&b.gapi.client.setApiKey(d),angular.forEach(e,function(b,d){a.push(c.when(gapi.client.load(d,b)))}),c.all(a).then(function(){f.resolve(b.gapi)})})},f.promise}]);var module=angular.module("drive",["gapi"]);module.service("drive",["$q","$cacheFactory","googleApi","applicationId",function(a,b,c,d){var e="id,title,mimeType,userPermission,editable,copyable,shared,fileSize,downloadUrl",f="items(anchor,author,commentId,content)",g="fileSize,id",h=b("files"),i=function(a,b,c,d){var e=a.userPermission,f="owner"===e.role||"writer"===e.role,g=f||"reader"===e.role&&e.additionalRoles&&e.additionalRoles.indexOf("commenter")>=0,i={userCanEdit:f,userCanComment:g},j={metadata:a,content:b,revision:c,comments:d,permissions:i};return h.put(a.id,j),j};this.loadFile=function(b){var d=h.get(b);return d?a.when(d):c.then(function(c){var d=c.client.drive.files.get({fileId:b,fields:e}),h=c.client.drive.files.get({fileId:b,alt:"media"}),i=c.client.drive.revisions.get({fileId:b,fields:g,revisionId:"head"}),j=c.client.drive.comments.list({fileId:b,fields:f});return a.all([a.when(d),a.when(h),a.when(i),a.when(j)])}).then(function(a){var b=JSON.parse(a[3].body).items;return b.forEach(function(a){a.anchor&&(a.anchor=JSON.parse(a.anchor))}),i(a[0].result,a[1].body,JSON.parse(a[2].body),b)})},this.saveFile=function(b,d){return c.then(function(c){var f,g;b.id?(f="/upload/drive/v2/files/"+encodeURIComponent(b.id),g="PUT"):(f="/upload/drive/v2/files",g="POST");var h=(new MultiPartBuilder).append("application/json",JSON.stringify(b)).append(b.mimeType,d).finish(),i=c.client.request({path:f,method:g,params:{uploadType:"multipart",fields:e},headers:{"Content-Type":h.type},body:h.body});return a.when(i)}).then(function(a){return i(a.result,d)})},this.insertComment=function(b,d){return c.then(function(c){var e={content:d.content,anchor:JSON.stringify(d.anchor)},f=c.client.drive.comments.insert({fileId:b,resource:e});return a.when(f)}).then(function(a){var c=h.get(b);if(c&&c.comments){var d=JSON.parse(a.body);d.anchor&&(d.anchor=JSON.parse(d.anchor)),c.comments.push(d)}})},this.updateComment=function(b,d,e){return c.then(function(c){var f={content:e},g=c.client.drive.comments.patch({fileId:b,commentId:d,resource:f});return a.when(g)}).then(function(a){var c=h.get(b);c&&c.comments&&c.comments.forEach(function(a){a.commentId===d&&(a.content=e)})})},this.deleteComment=function(b,d){return c.then(function(c){var e=c.client.drive.comments["delete"]({fileId:b,commentId:d});return a.when(e)}).then(function(a){var c=h.get(b);if(c&&c.comments)for(var e=0;e<c.comments.length;++e){var f=c.comments[e];if(f.commentId===d){c.comments.splice(e,1);break}}})},this.showPicker=function(){return c.then(function(b){var c=a.defer(),e=new google.picker.DocsView;e.setIncludeFolders(!0);var f=(new google.picker.PickerBuilder).setAppId(d).setOAuthToken(b.auth.getToken().access_token).addView(e).setCallback(function(a){if("picked"==a.action){var b=a.docs[0].id;c.resolve(b)}else"cancel"==a.action&&c.reject()}).build();return f.setVisible(!0),c.promise})},this.showSharing=function(a){return c.then(function(b){var c=new b.drive.share.ShareClient(d);c.setItemIds([a]),c.showSettingsDialog()})}}]);var module=angular.module("login",["gapi"]);module.service("login",["$q","googleApi","clientId","scope",function(a,b,c,d){var e=function(){var a=gapi.auth.getToken();return a&&Date.now()<a.expires_at},f=function(a,b){var e={client_id:c,scope:d,immediate:a};return b&&(e.login_hint=b,e.authuser=-1),e},g=function(c){return b.then(function(b){if(e())return b.auth.getToken();var d=a.defer();return b.auth.authorize(c,function(a){if(a&&!a.error)d.resolve(a);else{var b="AUTH_ERROR";d.reject(b)}}),d.promise})};this.login=function(a){var b=f(!1,a);return g(b)},this.checkAuth=function(a){var b=f(!0,a);return g(b)}}]),angular.module("codeReviewApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngAria","ui.ace","ui.scrollpoint","drive","login","uuid","hc.marked"]),angular.module("codeReviewApp").constant("apiKey",null).constant("clientId","669299579698-6fvvrtmplsldbpkjv1grvl7ft7ukaam9.apps.googleusercontent.com").constant("applicationId","669299579698").constant("scope",["email","profile","https://www.googleapis.com/auth/drive","https://www.googleapis.com/auth/drive.install"]).constant("loadApis",{drive:"v2"}),angular.module("codeReviewApp").config(["markedProvider",function(a){a.setOptions({gfm:!0,tables:!0,highlight:function(a,b){return b?hljs.highlight(b,a,!0).value:hljs.highlightAuto(a).value}})}]),angular.module("codeReviewApp").config(["$routeProvider","SECURED_ROUTES",function(a,b){a.whenAuthenticated=function(c,d){return d.resolve=d.resolve||{},d.resolve.user=["login",function(a){return a.checkAuth()}],a.when(c,d),b[c]=!0,a}}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).whenAuthenticated("/:fileId",{templateUrl:"views/editor.html",controller:"EditorCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","login","SECURED_ROUTES","loginRedirectPath",function(a,b,c,d,e){a.$on("$routeChangeError",function(a,c,d,f){"AUTH_ERROR"===f&&b.path(e)})}]).constant("SECURED_ROUTES",{}).constant("loginRedirectPath","/"),angular.module("codeReviewApp").directive("codeEditor",function(){return{templateUrl:"views/code-editor.html",replace:!0,controller:"CodeEditorCtrl",controllerAs:"ctrl"}}).controller("CodeEditorCtrl",["$scope","$timeout",function(a,b){var c=require("ace/range").Range;a.editor=null,a.shouldUpdateCursor=!0,a.isRangeSelected=!1,a.aceLoaded=function(b){b.setReadOnly(!0),b.setHighlightActiveLine(!1),b.$blockScrolling=1/0,b.renderer.setAnimatedScroll(!0),b.selection.on("changeCursor",d),b.selection.on("changeSelection",e),b.on("change",f),a.editor=b};var d=function(){var c=a.editor.selection.getCursor(),d=a.editor.session.doc.positionToIndex(c);b(function(){a.shouldUpdateCursor=!1,a.selectCommentsAtOffset(d),f()})},e=function(){var c=a.editor.selection.getRange();c.isEmpty()?a.isRangeSelected=!1:a.isRangeSelected=!0,b(function(){f()})};a.$watch("selectedComments",function(c){if(!a.shouldUpdateCursor)return void(a.shouldUpdateCursor=!0);if(0!==c.length){var e=a.editor.selection;e.off("changeCursor",d);var g=c[c.length-1],i=g.offset,j=h(i,0);e.setSelectionAnchor(j.start.row,j.start.column),e.moveCursorToPosition(j.start),a.editor.scrollToLine(j.start.row,!0,!0,null),f(),b(function(){e.on("changeCursor",d)})}}),a.$watchCollection("comments",function(){f()});var f=function(){var b=a.editor.session.getMarkers();for(var c in b){var d=b[c].clazz;("comment-range"==d||"comment-range-selected"==d)&&a.editor.session.removeMarker(c)}a.comments.forEach(function(a){g(a)})},g=function(b){var c=h(b.offset,b.len);b.selected?a.editor.session.addMarker(c,"comment-range-selected","text"):a.editor.session.addMarker(c,"comment-range","text")},h=function(b,d){var e=a.editor.getSession().getDocument(),f=e.indexToPosition(b),g=e.indexToPosition(b+d),h=new c(f.row,f.column,g.row,g.column);return h},i=function(b){var c=a.editor.getSession().getDocument(),d=c.positionToIndex(b.start),e=c.positionToIndex(b.end),f=e-d;return{o:d,l:f,ml:+a.file.revision.fileSize}};a.insertCommentAtSelection=function(){var b=a.editor.getSelectionRange();if(!b.isEmpty()){var c=i(b);a.insertComment(c.o,c.l)}},a.codeOutput="";var j=function(b){a.codeOutput+=b},k=function(b){a.errorOutput+=b},l=function(){a.codeOutput="",a.errorOutput=""};a.runCode=function(){l();var b=a.file.content;Sk.pre="output",Sk.configure({output:j});var c=Sk.misceval.asyncToPromise(function(){return Sk.importMainWithBody("<stdin>",!1,b,!0)});c.then(function(a){console.log("success")},function(b){console.log(b.toString()),a.$apply(function(){k(b.toString())})})}}]),angular.module("codeReviewApp").directive("commentList",function(){return{templateUrl:"views/comment-list.html",controller:"CommentListCtrl",controllerAs:"ctrl"}}).controller("CommentListCtrl",["$scope","$timeout",function(a,b){a.$watch("selectedComments",function(a){0!==a.length&&b(function(){var b=a[0].id,c=angular.element(document.querySelector("#comment-"+b)),d=c.position().top;$("body").animate({scrollTop:d-40})})})}]),angular.module("codeReviewApp").controller("MainCtrl",["$scope","$location","login","drive",function(a,b,c,d){a.loading=!0,a.isLoggedIn=!1,c.checkAuth().then(function(){a.isLoggedIn=!0})["finally"](function(){a.loading=!1}),a.login=function(){c.login().then(function(){a.isLoggedIn=!0})},a.openFile=function(){d.showPicker().then(function(a){b.path("/"+a)})}}]),angular.module("codeReviewApp").controller("EditorCtrl",["$scope","$routeParams","drive","rfc4122",function(a,b,c,d){a.file=null,a.comments=[],a.selectedComments=[],a.selectComment=function(b){a.selectCommentsAtOffset(b.offset)},a.selectCommentsAtOffset=function(b){a.selectedComments=[],a.comments.forEach(function(c){e(c,b)?(a.selectedComments.push(c),c.selected=!0):c.selected=!1})};var e=function(a,b){return b>=a.offset&&b<a.offset+a.len};a.insertComment=function(b,c){var e={id:"unsaved-"+d.v4(),offset:b,len:c,content:"",selected:!1,saved:!1,editing:!0};a.comments.push(e),a.comments.sort(function(a,b){return a.offset-b.offset}),a.selectCommentsAtOffset(b)},a.saveComment=function(d){if(d.saved)return void c.updateComment(b.fileId,d.id,d.content).then(function(){d.editing=!1});var e={r:a.file.revision.id,a:[{txt:{o:d.offset,l:d.len,ml:+a.file.revision.fileSize}}]},g={content:d.content,anchor:e};c.insertComment(b.fileId,g).then(function(){f(d)})};var f=function(b){for(var c=b.id,d=0;d<a.comments.length;++d){var e=a.comments[d];if(e.id===c){a.comments.splice(d,1);break}}};a.cancelEditing=function(a){return a.saved?(a.content=a.previousContent,delete a.previousContent,void(a.editing=!1)):void f(a)},a.beginEditing=function(a){a.editing=!0,a.previousContent=a.content},a.deleteComment=function(a){c.deleteComment(b.fileId,a.id)};var g=function(){var d=c.loadFile(b.fileId);return d.then(function(b){a.file=b},function(){console.log("Unable to load file")})};a.$watchCollection("file.comments",function(b){b&&(a.comments=[],b.forEach(function(b){if(b.hasOwnProperty("anchor")){var c=b.anchor.a[0].txt,d={id:b.commentId,offset:c.o,len:c.l,content:b.content,authorName:b.author.displayName,isAuthenticatedUser:b.author.isAuthenticatedUser,selected:!1,saved:!0,editing:!1};a.comments.push(d)}}),a.comments.sort(function(a,b){return a.offset-b.offset}))}),g()}]);